#!/bin/sh

set -eu

PROGRAM=linode-api
LINODE_API_TOKEN="${LINODE_API_TOKEN:-}"
LINODE_API_PATH=
LINODE_API_BODY=
LINODE_API_FILTER=
LINODE_API_METHOD=GET
LINODE_API_PREFIX="${LINODE_API_PREFIX:-https://api.linode.com/v4}"
CURL_EXEC="${CURL_EXEC:-curl}"
JQ_EXEC="${JQ_EXEC:-jq}"

usage() {
  cat <<EOF
Usage: $PROGRAM [OPTIONS] -k TOKEN -p PATH

Query Linode API and output JSON, even under error conditions.

This program will always exit with return code 0 unless it is called with
invalid arguments.

See https://www.linode.com/docs/api for more information.

Required arguments:
  -k, --token=TOKEN      Personal access token
  -p, --path=PATH        Appended to prefix to form URL

Optional arguments:
  -b, --body=BODY        JSON Body (default none)
  -f, --filter=FILTER    JSON Filter (default none)
  -m, --method=METHOD    HTTP method (default $LINODE_API_METHOD)
      --prefix=PREFIX    URL prefix (default $LINODE_API_PREFIX)
  -h, --help             This help text

Enviroment variable mappings:
  LINODE_API_TOKEN       --token
  LINODE_API_PREFIX      --prefix
  CURL_EXEC              Path to curl
  JQ_EXEC                Path to jq

Examples:
  \$ $PROGRAM -k badtoken -p /profile
  {"errors": [{"reason": "Invalid Token"}]}

  \$ $PROGRAM -k c96...9d9 -p /profile
  {"uid": 1234, ...}
EOF
}

_error() {
  [ $# -gt 0 ] && echo >&2 "$PROGRAM:" "$@"
  echo >&2 "Try '$PROGRAM --help' for more information."
  exit 1
}

_make_error() {
  # shellcheck disable=SC2016
  "$JQ_EXEC" -cn --arg _ "$*" '{"errors":[{"reason":$_}]}'
}

opts="$(
  getopt -n "$PROGRAM" -o k:p:b:f:m:h \
    -l token:,path:,body:,filter:,method:,prefix:,help -- "$@"
)" || _error
# shellcheck disable=SC2086
eval set -- $opts

while [ $# -gt 0 ]; do
  ARG="$1"
  shift
  case "$ARG" in
  -k | --token)
    LINODE_API_TOKEN="$1"
    shift
    ;;
  -p | --path)
    LINODE_API_PATH="$1"
    shift
    ;;
  -b | --body)
    LINODE_API_BODY="$1"
    shift
    ;;
  -f | --filter)
    LINODE_API_FILTER="$1"
    shift
    ;;
  -m | --method)
    LINODE_API_METHOD="$1"
    shift
    ;;
  --prefix)
    LINODE_API_PREFIX=1
    ;;
  -h | --help)
    usage
    exit 0
    ;;
  --) ;;
  *)
    _error "unexpected argument '$ARG'"
    ;;
  esac
done

[ -z "$LINODE_API_TOKEN" ] && _error "missing TOKEN"
[ -z "$LINODE_API_PATH" ] && _error "missing PATH"

which "$CURL_EXEC" >/dev/null || _error "curl not installed"
which jq >/dev/null || _error "jq not installed"

tmp_output="$(mktemp)"
tmp_stderr="$(mktemp)"

trap 'rm -f -- "$tmp_output" "$tmp_stderr"' EXIT

set -- "-sS" "-o" "$tmp_output" \
  -H "Authorization: Bearer $LINODE_API_TOKEN" \
  -H "Content-type: application/json"

[ -n "$LINODE_API_BODY" ] && set -- "$@" -d "$LINODE_API_BODY"
[ -n "$LINODE_API_FILTER" ] && set -- "$@" -H "X-Filter: $LINODE_API_FILTER"
[ -n "$LINODE_API_METHOD" ] && set -- "$@" -X "$LINODE_API_METHOD"

set +e
"$CURL_EXEC" "$@" "${LINODE_API_PREFIX}${LINODE_API_PATH}" 2>"$tmp_stderr"
result=$?
set -e

if [ $result != 0 ]; then
  if [ -s "$tmp_stderr" ]; then
    _make_error "$(cat "$tmp_stderr")"
  else
    _make_error "Unknown error"
  fi
else
  if [ -s "$tmp_output" ]; then
    cat "$tmp_output"
  else
    _make_error "No data"
  fi
fi

exit 0
